#
# GitHub Actions Workflow to automatically build the NGINX binary, the ACME module,
# package them with commented configuration templates, and release them as a single archive.
# This workflow targets the latest Debian Stable release.
#
# This workflow is triggered by:
# 1. A push to the 'master' branch.
# 2. A manual dispatch from the Actions UI.
#

name: Build and Release NGINX and ACME Module Package

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'Optional: Specify an NGINX version to build (e.g., 1.28.0)'
        required: false
        default: ''
  schedule:
    - cron: '30 5 * * *'
  push:
    branches:
      - master

# Grant permissions for the GITHUB_TOKEN to create releases.
permissions:
  contents: write

jobs:
  # This job checks if a build is necessary.
  check-for-new-version:
    name: Check for New NGINX Stable Version
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check_versions.outputs.should_build }}
      version: ${{ steps.check_versions.outputs.version }}
    steps:
      - name: Determine version and if build is needed
        id: check_versions
        run: |
          MANUAL_VERSION="${{ github.event.inputs.nginx_version }}"

          if [ -n "$MANUAL_VERSION" ]; then
            echo "Manual version specified: $MANUAL_VERSION. Forcing build."
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "version=$MANUAL_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "No manual version specified. Detecting latest stable version..."
            LATEST_STABLE=$(curl -s https://nginx.org/download/ | \
              grep -o 'nginx-[0-9.]\+\.tar\.gz' | \
              sed -e 's/nginx-//' -e 's/\.tar\.gz//' | \
              awk -F. '$2 % 2 == 0' | \
              sort -V | \
              tail -n 1)

            if [ -z "$LATEST_STABLE" ]; then
              echo "ERROR: Failed to parse latest stable NGINX version."
              exit 1
            fi
            echo "Latest stable NGINX version is: $LATEST_STABLE"

            LATEST_RELEASE_TAG=$(curl -sf -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
              jq -r .tag_name || true)

            if [ -z "$LATEST_RELEASE_TAG" ]; then
              echo "No previous release found. Triggering initial build."
              echo "should_build=true" >> "$GITHUB_OUTPUT"
            else
              LAST_RELEASED_VERSION=$(echo "$LATEST_RELEASE_TAG" | sed 's/^nginx-//')
              echo "Last released version is: $LAST_RELEASED_VERSION"
              if [ "$LATEST_STABLE" != "$LAST_RELEASED_VERSION" ]; then
                echo "New version detected ($LATEST_STABLE). Proceeding with build."
                echo "should_build=true" >> "$GITHUB_OUTPUT"
              else
                echo "Version $LATEST_STABLE is already the latest. Build skipped."
                echo "should_build=false" >> "$GITHUB_OUTPUT"
              fi
            fi
            echo "version=$LATEST_STABLE" >> "$GITHUB_OUTPUT"
          fi

  # This job builds and packages NGINX on the latest Debian Stable release.
  build-debian:
    name: Build and Package for Debian Stable
    needs: check-for-new-version
    if: needs.check-for-new-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    container: debian:stable

    steps:
      # Step 1: Install all necessary dependencies.
      - name: Install Build Dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential libclang-dev pkg-config libpcre2-dev zlib1g-dev libssl-dev \
            libxml2-dev libxslt1-dev libgd-dev libgeoip-dev libperl-dev \
            wget git curl ca-certificates jq

      # Step 2: Install the Rust toolchain.
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      # Step 3: Download source code and build NGINX with the ACME module.
      - name: Download and Build
        env:
          NGINX_VERSION: ${{ needs.check-for-new-version.outputs.version }}
        run: |
          wget -q http://nginx.org/download/nginx-$NGINX_VERSION.tar.gz
          tar -zxf nginx-$NGINX_VERSION.tar.gz
          git clone --depth 1 https://github.com/nginx/nginx-acme.git
          cd nginx-$NGINX_VERSION

          BUILD_PATH=$(pwd)
          CC_OPT_VALUE="-g -O2 -ffile-prefix-map=$BUILD_PATH=. -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fPIC"

          ./configure \
            --with-cc-opt="$CC_OPT_VALUE" \
            --with-ld-opt='-Wl,-z,relro -Wl,-z,now -Wl,--as-needed -fPIC' \
            --prefix=/usr/share/nginx \
            --conf-path=/etc/nginx/nginx.conf \
            --http-log-path=/var/log/nginx/access.log \
            --error-log-path=/var/log/nginx/error.log \
            --lock-path=/var/lock/nginx.lock \
            --pid-path=/run/nginx.pid \
            --modules-path=/usr/lib/nginx/modules \
            --http-client-body-temp-path=/var/lib/nginx/body \
            --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \
            --http-proxy-temp-path=/var/lib/nginx/proxy \
            --http-scgi-temp-path=/var/lib/nginx/scgi \
            --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \
            --with-compat \
            --with-debug \
            --with-pcre-jit \
            --with-http_ssl_module \
            --with-http_stub_status_module \
            --with-http_realip_module \
            --with-http_auth_request_module \
            --with-http_v2_module \
            --with-http_dav_module \
            --with-http_slice_module \
            --with-threads \
            --with-http_addition_module \
            --with-http_gunzip_module \
            --with-http_gzip_static_module \
            --with-http_mp4_module \
            --with-http_random_index_module \
            --with-http_secure_link_module \
            --with-http_sub_module \
            --with-mail_ssl_module \
            --with-stream_ssl_module \
            --with-stream_ssl_preread_module \
            --with-stream_realip_module \
            --with-http_geoip_module=dynamic \
            --with-http_image_filter_module=dynamic \
            --with-http_perl_module=dynamic \
            --with-http_xslt_module=dynamic \
            --with-mail=dynamic \
            --with-stream=dynamic \
            --with-stream_geoip_module=dynamic \
            --add-dynamic-module=../nginx-acme/

          make

      # Step 4: Package the artifacts with configuration templates.
      - name: Package Artifacts
        env:
          NGINX_VERSION: ${{ needs.check-for-new-version.outputs.version }}
        run: |
          SOURCE_DIR="nginx-$NGINX_VERSION"
          MODULE_PATH="$SOURCE_DIR/objs/ngx_http_acme_module.so"
          NGINX_BINARY_PATH="$SOURCE_DIR/objs/nginx"

          if [ ! -f "$MODULE_PATH" ] || [ ! -f "$NGINX_BINARY_PATH" ]; then
            echo "::error::Build failed! One or more required files were not created."
            exit 1
          fi

          echo "Build successful. Packaging artifacts with templates..."

          PACKAGE_BASE_DIR="nginx-acme-package"
          # Create the desired directory structure
          mkdir -p "$PACKAGE_BASE_DIR/sbin"
          mkdir -p "$PACKAGE_BASE_DIR/modules"
          mkdir -p "$PACKAGE_BASE_DIR/vhost.d"
          mkdir -p "$PACKAGE_BASE_DIR/acme"

          # Copy compiled files
          cp "$NGINX_BINARY_PATH" "$PACKAGE_BASE_DIR/sbin/nginx"
          cp "$MODULE_PATH" "$PACKAGE_BASE_DIR/modules/ngx_http_acme_module.so"

          # Copy and modify config files
          cp "$SOURCE_DIR/conf/mime.types" "$PACKAGE_BASE_DIR/"
          cp "$SOURCE_DIR/conf/nginx.conf" "$PACKAGE_BASE_DIR/"

          # --- FIX: Add commented-out instructions to nginx.conf ---
          sed -i '1s|^|# To enable the NGINX ACME module, uncomment the following line:\n# load_module modules/ngx_http_acme_module.so;\n\n|' "$PACKAGE_BASE_DIR/nginx.conf"
          sed -i 's|include       conf.d/\*.conf;|include       vhost.d/\*.conf;|' "$PACKAGE_BASE_DIR/nginx.conf"

          # --- FIX: Create a detailed vhost example file ---
          cat <<'EOF' > "$PACKAGE_BASE_DIR/vhost.d/default.conf.example"
          # This is an example virtual host configuration file.
          # To use it, rename this file to 'your_site.conf' and fill in your details.

          server {
              listen 80;
              listen [::]:80;

              # Replace with your domain(s)
              server_name your_domain.com;

              # This location is required by the ACME module to solve the HTTP-01 challenge.
              # Make sure the root path exists and is readable by the NGINX worker user.
              location /.well-known/acme-challenge/ {
                  root /var/www/html;
              }

              # After obtaining a certificate, all HTTP traffic should be redirected to HTTPS.
              location / {
                  return 301 https://$host$request_uri;
              }
          }

          # --- HTTPS Server Block (Your main configuration) ---
          #
          # After the first successful certificate acquisition, uncomment this block.
          #
          # server {
          #     listen 443 ssl http2;
          #     listen [::]:443 ssl http2;
          #
          #     server_name your_domain.com;
          #
          #     # --- ACME Module Configuration ---
          #     # This enables automatic certificate management for this server block.
          #     acme on;
          #
          #     # Define the path where certificates and account keys will be stored.
          #     # IMPORTANT: Use the ABSOLUTE path to the 'acme' directory.
          #     # Example: /home/user/nginx-acme-package/acme
          #     acme_storage_path /absolute/path/to/nginx-acme-package/acme;
          #
          #     # Tell the module which certificate to manage.
          #     acme_certificate your_domain.com {
          #         # Set your Let's Encrypt account email (required).
          #         account mail@your_domain.com;
          #         # Add any alternative domains for the same certificate (optional).
          #         # domains www.your_domain.com;
          #     }
          #
          #     # Point NGINX to the certificate and key files managed by the ACME module.
          #     # The paths are relative to the 'acme_storage_path' defined above.
          #     ssl_certificate your_domain.com/fullchain.pem;
          #     ssl_certificate_key your_domain.com/key.pem;
          #
          #     # Recommended: Add modern SSL/TLS parameters for security.
          #     # ssl_protocols TLSv1.2 TLSv1.3;
          #     # ssl_ciphers HIGH:!aNULL:!MD5;
          #
          #     # Your website's root directory and other configurations go here.
          #     root /var/www/html/your_domain;
          #     index index.html;
          #
          #     location / {
          #         try_files $uri $uri/ =404;
          #     }
          # }
          EOF

          # --- FIX: Create a new, more detailed README file ---
          cat <<EOF > "$PACKAGE_BASE_DIR/README.txt"
          # NGINX with ACME Module Package

          This package contains NGINX version ${{ needs.check-for-new-version.outputs.version }} pre-compiled with the nginx-acme module for Debian Stable.

          ## Quick Start Guide

          **Step 1: Unpack the Archive**
          \`\`\`bash
          tar -xzf <archive-name>.tar.gz
          cd nginx-acme-package
          \`\`\`

          **Step 2: Enable the ACME Module**
          Open the \`nginx.conf\` file and uncomment the following line at the top:
          \`\`\`nginx
          # load_module modules/ngx_http_acme_module.so;
          \`\`\`
          becomes:
          \`\`\`nginx
          load_module modules/ngx_http_acme_module.so;
          \`\`\`

          **Step 3: Configure Your Website**
          1. Rename the example virtual host file:
             \`\`\`bash
             mv vhost.d/default.conf.example vhost.d/your_site.conf
             \`\`\`
          2. Edit \`vhost.d/your_site.conf\` and replace all placeholders like \`your_domain.com\`, \`/var/www/html\`, and especially \`/absolute/path/to/nginx-acme-package/acme\` with your actual data.

          **Step 4: Create Required Directories**
          Make sure the web root directory you specified in your config file exists (e.g., \`mkdir -p /var/www/html\`). The \`acme\` directory is already created for you.

          **Step 5: Start NGINX**
          It is crucial to start NGINX from within the \`nginx-acme-package\` directory using the \`-p\` flag. This tells NGINX where to find its configuration and modules.
          \`\`\`bash
          # Test your configuration first
          ./sbin/nginx -p \$(pwd) -c nginx.conf -t

          # If the test is successful, start NGINX
          ./sbin/nginx -p \$(pwd) -c nginx.conf
          \`\`\`

          **Step 6: Manage NGINX**
          Use these commands from the \`nginx-acme-package\` directory:
          - **Reload config:** \`./sbin/nginx -p \$(pwd) -s reload\`
          - **Stop NGINX:** \`./sbin/nginx -p \$(pwd) -s stop\`
          EOF

          # Create the compressed archive
          ARTIFACT_NAME="nginx-${NGINX_VERSION}-acme-debian-stable.tar.gz"
          tar -czf "$ARTIFACT_NAME" "$PACKAGE_BASE_DIR"

          # Prepare for upload
          ARTIFACT_DIR=artifact
          mkdir -p "$ARTIFACT_DIR"
          mv "$ARTIFACT_NAME" "$ARTIFACT_DIR/"
          sha256sum "$ARTIFACT_DIR/$ARTIFACT_NAME" > "$ARTIFACT_DIR/$ARTIFACT_NAME.sha256"
          echo "Packaged artifact created: $ARTIFACT_DIR/$ARTIFACT_NAME"

      # Step 5: Upload the packaged artifact to be used in the release job.
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-package-debian-stable
          path: artifact/

  # This job creates a GitHub Release after the build is successful.
  create-release:
    name: Create GitHub Release
    needs: [check-for-new-version, build-debian]
    if: needs.check-for-new-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist

      - name: List downloaded files for debugging
        run: ls -R ./dist

      - name: Prepare release content
        id: prep
        run: |
          mkdir -p release-assets
          find ./dist -name "*.tar.gz" -exec mv {} ./release-assets/ \;

          echo "### SHA256 Checksum" > release-body.md
          echo '```' >> release-body.md
          find ./dist -name "*.sha256" -exec cat {} + >> release-body.md
          echo '```' >> release-body.md
          {
            echo "body<<EOF"
            cat release-body.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: nginx-${{ needs.check-for-new-version.outputs.version }}
          name: NGINX ${{ needs.check-for-new-version.outputs.version }} with ACME Module Package (Debian Stable)
          body: ${{ steps.prep.outputs.body }}
          files: ./release-assets/*
